<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Japanese Test (VI/EN)</title>

    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #282c34;
            color: #61dafb;
            padding: 20px;
        }
        h1 {
            color: #61dafb;
            text-align: center;
        }
        .card {
            background-color: #1c2025;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .term { color: lightgreen; font-weight: bold; }
        .ipa { color: yellow; }
        .romaji { color: #f0e68c; }
        .vietnamese { color: #61dafb; }

        input, button {
            margin: 5px;
            padding: 10px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
        }
        button {
            background-color: #61dafb;
            color: #282c34;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #21a1f1; }

        #questionCounter {
            font-size: 16px;
            color: white;
            text-align: center;
            font-weight: bold;
            margin: 10px 0;
        }

        #vocabLabel {
            font-size: 24px;
            margin: 20px 0;
            border: 2px solid #61dafb;
            padding: 20px;
            text-align: center;
            max-width: 800px;
            margin: 0 auto;
            overflow-y: auto;
            max-height: 400px;
            background-color: #1c2025;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #notification {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            text-align: left;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            color: #ffffff;
            background-color: #f44336;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            max-width: 80%;
            z-index: 1000;
        }
    </style>
</head>

<body>

<!-- TOP RIGHT: HELP + LANGUAGE SELECTOR -->
<div style="position:fixed; top:10px; right:10px; z-index:999; display:flex; gap:8px; align-items:center;">
    <a id="helpLink" href="help.html" target="_blank"
       style="background:#61dafb;color:#08212b;padding:8px 12px;border-radius:6px;text-decoration:none;font-weight:bold;">
        H∆∞·ªõng d·∫´n
    </a>

    <select id="langSelector" onchange="changeLanguage()"
            style="padding:6px 8px; border-radius:6px; border:none; background:#1c2025; color:#61dafb;">
        <option value="vi">VI</option>
        <option value="en">EN</option>
    </select>
</div>

<div style="text-align:center;">
    <div id="questionCounter">C√¢u h·ªèi: 0/0</div>
</div>

<div id="vocabLabel">Kh√¥ng c√≥ t·ª´ v·ª±ng n√†o ƒë∆∞·ª£c th√™m.</div>

<!-- VISIBILITY CHECKBOXES -->
<div style="text-align:center;">
    <label><input type="checkbox" onchange="toggleVisibility('term')"> <span id="lblHideJa">·∫®n Ja</span></label>
    <label><input type="checkbox" onchange="toggleVisibility('ipa')"> <span id="lblHideIPA">·∫®n IPA</span></label>
    <label><input type="checkbox" onchange="toggleVisibility('romaji')"> <span id="lblHideR">·∫®n R</span></label>
    <label><input type="checkbox" onchange="toggleVisibility('vietnamese')"> <span id="lblHideVi">·∫®n Vi</span></label>
    <label><input type="checkbox" id="autoCheckToggle" onchange="toggleAutoCheck()"> <span id="lblAutoCheck">T·ª± ƒë·ªông ki·ªÉm tra</span></label>
</div>

<div id="notification"></div>

<!-- ANSWER INPUTS -->
<textarea id="answerInput" placeholder="Ki·ªÉm tra kanji (V1)" onkeydown="handleKeyDown(event)"></textarea>
<textarea id="answerInputV2" placeholder="Ki·ªÉm tra hiragana (V2)" onkeydown="handleKeyDownV2(event)"></textarea>
<textarea id="answerInputV3" placeholder="Ki·ªÉm tra romaji (V3)" onkeydown="handleKeyDownV3(event)"></textarea>
<textarea id="answerInputV4" placeholder="Ki·ªÉm tra ti·∫øng Vi·ªát (V4)" onkeydown="handleKeyDownV4(event)"></textarea>

<!-- CHECK BUTTONS -->
<div style="text-align:center;">
    <button id="checkAnswerButton" onclick="checkAnswer()">V1</button>
    <button id="checkAnswerV2Button" onclick="checkAnswerV2()">V2</button>
    <button id="checkAnswerV3Button" onclick="checkAnswerV3()">V3</button>
    <button id="checkAnswerV4Button" onclick="checkAnswerV4()">V4</button>
</div>

<!-- HIDE INPUT FRAMES -->
<div style="text-align:center; margin-top:6px;">
    <label><input type="checkbox" id="hideV1Checkbox" onchange="toggleVFrame(1)"> ·∫®n V1</label>
    <label><input type="checkbox" id="hideV2Checkbox" onchange="toggleVFrame(2)"> ·∫®n V2</label>
    <label><input type="checkbox" id="hideV3Checkbox" onchange="toggleVFrame(3)"> ·∫®n V3</label>
    <label><input type="checkbox" id="hideV4Checkbox" onchange="toggleVFrame(4)"> ·∫®n V4</label>
</div>

<!-- NAVIGATION BUTTONS -->
<div style="text-align:center;">
    <button id="btnPrev" onclick="prevWord()">Tr∆∞·ªõc</button>
    <button id="btnNext" onclick="nextWord()">Ti·∫øp Theo</button>
    <button id="repeatButton" onclick="repeatPronunciation()">L·∫∑p L·∫°i</button>
    <button id="autoFlipButton" onclick="toggleAutoFlip()">T·ª± ƒê·ªông</button>
    <button id="toggleModeButton" onclick="toggleMode()">Th·ª© T·ª±</button>
</div>

<!-- LESSON + AUDIO + RANGE -->
<div style="text-align:center;">
    <select id="lessonSelector" onchange="loadLesson()"></select>

    <select id="audioEngineSelector" style="padding:8px; margin-left:8px; border-radius:6px;">
        <option value="gTTS">(Loading engines...)</option>
    </select>

    <label style="margin-left:8px;">
        <span id="lblSpeed">T·ªëc ƒë·ªô:</span>
        <select id="playbackSpeedSelector" style="padding:6px; margin-left:6px; border-radius:6px;">
            <option value="1">B√¨nh th∆∞·ªùng</option>
            <option value="0.85">Ch·∫≠m</option>
            <option value="0.7">R·∫•t ch·∫≠m</option>
        </select>
    </label>

    <label style="margin-left:8px;">
        <span id="lblPause">Kho·∫£ng ngh·ªâ (s):</span>
        <input type="number" id="autoIntervalInput" min="1" value="1" style="width:80px; margin-left:6px;">
    </label>

    <button id="bookmarkBtn" onclick="saveBookmark()" style="margin-left:6px; padding:8px 12px;">üîñ <span id="btnBookmarkText">L∆∞u</span></button>
    <button id="loadBookmarkBtn" onclick="loadBookmark()" style="margin-left:6px; padding:8px 12px;">üìÇ <span id="btnLoadBookmarkText">T·∫£i</span></button>

    <input type="number" id="rangeStart" placeholder="T·ª´ c√¢u" min="1" style="width:80px;">
    <span id="lblTo">ƒë·∫øn</span>
    <input type="number" id="rangeEnd" placeholder="ƒê·∫øn c√¢u" min="1" style="width:80px;">

    <button id="btnStartRange" onclick="startRangeSession()" style="padding:8px 15px;">B·∫Øt ƒë·∫ßu</button>
    <button id="btnResetSession" onclick="resetSession()" style="margin-top:10px; padding:8px 15px;">Reset Phi√™n H·ªçc</button>
</div>

<script>
/* ============================================================
   I18N ‚Äì H·ªÜ TH·ªêNG ƒêA NG√îN NG·ªÆ VI / EN
   ============================================================ */

const langVi = {
    help: "H∆∞·ªõng d·∫´n",
    questionLabel: "C√¢u h·ªèi",
    noVocab: "Kh√¥ng c√≥ t·ª´ v·ª±ng n√†o ƒë∆∞·ª£c th√™m.",
    hideJa: "·∫®n Ja",
    hideIPA: "·∫®n IPA",
    hideR: "·∫®n R",
    hideVi: "·∫®n Vi",
    autoCheck: "T·ª± ƒë·ªông ki·ªÉm tra",
    prev: "Tr∆∞·ªõc",
    next: "Ti·∫øp Theo",
    repeat: "L·∫∑p L·∫°i",
    autoFlip: "T·ª± ƒê·ªông",
    modeOrder: "Th·ª© T·ª±",
    modeRandom: "Ng·∫´u Nhi√™n",
    speed: "T·ªëc ƒë·ªô:",
    pause: "Kho·∫£ng ngh·ªâ (s):",
    bookmark: "L∆∞u",
    loadBookmark: "T·∫£i",
    fromSentence: "T·ª´ c√¢u",
    toSentence: "ƒë·∫øn",
    toSentencePlaceholder: "ƒê·∫øn c√¢u",
    startRange: "B·∫Øt ƒë·∫ßu",
    resetSession: "Reset Phi√™n H·ªçc",
    autoCheckOn: "T·ª± ƒë·ªông ki·ªÉm tra: B·∫¨T",
    autoCheckOff: "T·ª± ƒë·ªông ki·ªÉm tra: T·∫ÆT",
    rangeStartMissing: "Vui l√≤ng nh·∫≠p c√¢u b·∫Øt ƒë·∫ßu",
    rangeEndMissing: "Vui l√≤ng nh·∫≠p c√¢u k·∫øt th√∫c",
    rangeTooSmall: "S·ªë c√¢u ph·∫£i l·ªõn h∆°n 0",
    rangeInvalid: "C√¢u b·∫Øt ƒë·∫ßu ph·∫£i nh·ªè h∆°n c√¢u k·∫øt th√∫c",
    rangeEmpty: "Kh√¥ng c√≥ c√¢u n√†o trong kho·∫£ng n√†y",
    rangeStarted: (start, end) => `B·∫Øt ƒë·∫ßu phi√™n h·ªçc t·ª´ c√¢u ${start} ƒë·∫øn ${end}`,
    resetAll: "ƒê√£ reset phi√™n h·ªçc v·ªÅ to√†n b·ªô danh s√°ch",
    lessonNotFound: "B√†i h·ªçc kh√¥ng t·ªìn t·∫°i!",
    noVocabFound: "Kh√¥ng t√¨m th·∫•y t·ª´ v·ª±ng n√†o.",
    allDone: "T·∫•t c·∫£ t·ª´ v·ª±ng ƒë√£ ho√†n th√†nh.",
    modeSequential: "Th·ª© T·ª±",
    modeRandomLabel: "Ng·∫´u Nhi√™n",
    modeNotificationSequential: "Ch·∫ø ƒë·ªô: Th·ª© t·ª±",
    modeNotificationRandom: "Ch·∫ø ƒë·ªô: Ng·∫´u nhi√™n (m·ªói c√¢u 1 l·∫ßn)"
};

const langEn = {
    help: "Help",
    questionLabel: "Question",
    noVocab: "No vocabulary added.",
    hideJa: "Hide Ja",
    hideIPA: "Hide IPA",
    hideR: "Hide Romaji",
    hideVi: "Hide Vietnamese",
    autoCheck: "Auto check",
    prev: "Previous",
    next: "Next",
    repeat: "Repeat",
    autoFlip: "Auto",
    modeOrder: "Order",
    modeRandom: "Random",
    speed: "Speed:",
    pause: "Pause (s):",
    bookmark: "Save",
    loadBookmark: "Load",
    fromSentence: "From",
    toSentence: "to",
    toSentencePlaceholder: "To sentence",
    startRange: "Start",
    resetSession: "Reset Session",
    autoCheckOn: "Auto check: ON",
    autoCheckOff: "Auto check: OFF",
    rangeStartMissing: "Please enter start sentence",
    rangeEndMissing: "Please enter end sentence",
    rangeTooSmall: "Sentence number must be greater than 0",
    rangeInvalid: "Start sentence must be less than end sentence",
    rangeEmpty: "No sentence in this range",
    rangeStarted: (start, end) => `Start session from sentence ${start} to ${end}`,
    resetAll: "Session reset to full list",
    lessonNotFound: "Lesson not found!",
    noVocabFound: "No vocabulary found.",
    allDone: "All vocabulary completed.",
    modeSequential: "Order",
    modeRandomLabel: "Random",
    modeNotificationSequential: "Mode: Sequential",
    modeNotificationRandom: "Mode: Random (each sentence once)"
};

let currentLang = "vi";

function getLang() {
    return currentLang === "en" ? langEn : langVi;
}

function applyLanguage() {
    const L = getLang();

    // Help link
    const helpLink = document.getElementById("helpLink");
    if (helpLink) helpLink.textContent = L.help;

    // Question counter
    const qc = document.getElementById("questionCounter");
    if (qc) {
        const parts = qc.innerText.split(":");
        const tail = parts.length > 1 ? parts[1] : " 0/0";
        qc.innerText = `${L.questionLabel}:${tail}`;
    }

    // Default vocab label
    const vocabLabel = document.getElementById("vocabLabel");
    if (vocabLabel && (vocabLabel.innerText.trim() === langVi.noVocab || vocabLabel.innerText.trim() === langEn.noVocab)) {
        vocabLabel.innerText = L.noVocab;
    }

    // Checkbox labels
    const lblHideJa = document.getElementById("lblHideJa");
    if (lblHideJa) lblHideJa.textContent = L.hideJa;

    const lblHideIPA = document.getElementById("lblHideIPA");
    if (lblHideIPA) lblHideIPA.textContent = L.hideIPA;

    const lblHideR = document.getElementById("lblHideR");
    if (lblHideR) lblHideR.textContent = L.hideR;

    const lblHideVi = document.getElementById("lblHideVi");
    if (lblHideVi) lblHideVi.textContent = L.hideVi;

    const lblAutoCheck = document.getElementById("lblAutoCheck");
    if (lblAutoCheck) lblAutoCheck.textContent = L.autoCheck;

    // Navigation buttons
    const btnPrev = document.getElementById("btnPrev");
    if (btnPrev) btnPrev.textContent = L.prev;

    const btnNext = document.getElementById("btnNext");
    if (btnNext) btnNext.textContent = L.next;

    const repeatButton = document.getElementById("repeatButton");
    if (repeatButton) repeatButton.textContent = L.repeat;

    const autoFlipButton = document.getElementById("autoFlipButton");
    if (autoFlipButton) autoFlipButton.textContent = L.autoFlip;

    const toggleModeButton = document.getElementById("toggleModeButton");
    if (toggleModeButton) toggleModeButton.textContent = isRandomMode ? L.modeRandomLabel : L.modeOrder;

    // Speed / pause
    const lblSpeed = document.getElementById("lblSpeed");
    if (lblSpeed) lblSpeed.textContent = L.speed;

    const lblPause = document.getElementById("lblPause");
    if (lblPause) lblPause.textContent = L.pause;

    // Bookmark buttons
    const btnBookmarkText = document.getElementById("btnBookmarkText");
    if (btnBookmarkText) btnBookmarkText.textContent = L.bookmark;

    const btnLoadBookmarkText = document.getElementById("btnLoadBookmarkText");
    if (btnLoadBookmarkText) btnLoadBookmarkText.textContent = L.loadBookmark;

    // Range inputs
    const rangeStart = document.getElementById("rangeStart");
    if (rangeStart) rangeStart.placeholder = L.fromSentence;

    const lblTo = document.getElementById("lblTo");
    if (lblTo) lblTo.textContent = L.toSentence;

    const rangeEnd = document.getElementById("rangeEnd");
    if (rangeEnd) rangeEnd.placeholder = L.toSentencePlaceholder;

    const btnStartRange = document.getElementById("btnStartRange");
    if (btnStartRange) btnStartRange.textContent = L.startRange;

    const btnResetSession = document.getElementById("btnResetSession");
    if (btnResetSession) btnResetSession.textContent = L.resetSession;

    // Update selector
    const langSelector = document.getElementById("langSelector");
    if (langSelector) langSelector.value = currentLang;
}

function changeLanguage() {
    const sel = document.getElementById("langSelector");
    if (!sel) return;

    currentLang = sel.value;
    try {
        localStorage.setItem("app_lang", currentLang);
    } catch (e) {}

    applyLanguage();
}

document.addEventListener("DOMContentLoaded", () => {
    try {
        const saved = localStorage.getItem("app_lang");
        if (saved === "vi" || saved === "en") currentLang = saved;
    } catch (e) {}

    applyLanguage();
});
</script>
<script>

<!-- ============================================================
     PH·∫¶N 3 ‚Äî C√ÅC H√ÄM ƒê√É ƒê∆Ø·ª¢C CH·ªàNH S·ª¨A ƒê·ªÇ D√ôNG i18n
     ============================================================ -->

// ===================== TOGGLE AUTO CHECK ======================
function toggleAutoCheck() {
    const L = getLang();
    isAutoCheckEnabled = !isAutoCheckEnabled;

    const notification = document.getElementById('notification');
    notification.textContent = isAutoCheckEnabled ? L.autoCheckOn : L.autoCheckOff;
    notification.style.display = 'block';
    notification.style.backgroundColor = isAutoCheckEnabled ? '#4caf50' : '#f44336';

    setTimeout(() => notification.style.display = 'none', 2000);

    if (!isAutoCheckEnabled) {
        clearTimeout(typingTimer);
        document.getElementById('answerInput').classList.remove('typing');
    }
}


// ===================== START RANGE SESSION ======================
function startRangeSession() {
    const L = getLang();

    const start = parseInt(document.getElementById('rangeStart').value);
    const end = parseInt(document.getElementById('rangeEnd').value);

    if (isNaN(start)) {
        showNotification(L.rangeStartMissing, false);
        return;
    }

    if (isNaN(end)) {
        showNotification(L.rangeEndMissing, false);
        return;
    }

    if (start < 1 || end < 1) {
        showNotification(L.rangeTooSmall, false);
        return;
    }

    if (start > end) {
        showNotification(L.rangeInvalid, false);
        return;
    }

    sessionVocabList = vocabList.slice(start - 1, end);

    if (sessionVocabList.length === 0) {
        showNotification(L.rangeEmpty, false);
        return;
    }

    currentIndex = 0;
    vocabList = sessionVocabList;
    askedIndices = [];
    isRandomCycleComplete = false;
    isFront = true;

    showNotification(L.rangeStarted(start, end), true);
    displayWord();
}


// ===================== RESET SESSION ======================
function resetSession() {
    const L = getLang();
    const selectedLessonName = document.getElementById('lessonSelector').value;

    loadLesson();
    showNotification(L.resetAll, true);
}


// ===================== TOGGLE MODE (ORDER / RANDOM) ======================
function toggleMode() {
    const L = getLang();

    isRandomMode = !isRandomMode;

    document.getElementById("toggleModeButton").innerText =
        isRandomMode ? L.modeRandomLabel : L.modeSequential;

    askedIndices = [];
    isRandomCycleComplete = false;

    const notification = document.getElementById('notification');
    notification.textContent = isRandomMode
        ? L.modeNotificationRandom
        : L.modeNotificationSequential;

    notification.style.display = 'block';
    setTimeout(() => notification.style.display = 'none', 2000);
}


// ===================== DISPLAY WORD ======================
function displayWord() {
    const L = getLang();

    if (vocabList.length > 0 && currentIndex < vocabList.length) {
        const word = vocabList[currentIndex];

        const frontCard = `
            <div class="card">
                <div class="term" style="color: ${hiddenElements.term ? '#1c2025' : 'lightgreen'};">${word[0] || ''}</div>
                <div class="ipa" style="color: ${hiddenElements.ipa ? '#1c2025' : 'yellow'};">${word[1] || ''}</div>
                <div class="romaji" style="color: ${hiddenElements.romaji ? '#1c2025' : '#f0e68c'};">${word[2] || ''}</div>
                <div class="vietnamese" style="color: ${hiddenElements.vietnamese ? '#1c2025' : '#21a1f1'};">${word[3] || ''}</div>
            </div>
        `;

        document.getElementById('vocabLabel').innerHTML = frontCard;

        const pronunciationText = word[0].toString();

        if (isFront) {
            if (skipPlayOnDisplay) {
                skipPlayOnDisplay = false;
            } else {
                playPronunciation(pronunciationText);
            }
        }

        document.getElementById('answerInput').classList.remove('typing', 'checked');
        clearTimeout(typingTimer);

    } else {
        document.getElementById('vocabLabel').innerText = L.allDone;
    }

    updateQuestionCounter();
}


// ===================== UPDATE QUESTION COUNTER ======================
function updateQuestionCounter() {
    const L = getLang();
    const questionCounter = document.getElementById('questionCounter');
    questionCounter.innerText = `${L.questionLabel}: ${currentIndex + 1}/${vocabList.length}`;
}


// ===================== LOAD LESSON (i18n FIXES) ======================
function loadLesson() {
    const L = getLang();

    currentIndex = 0;
    askedIndices = [];
    isRandomCycleComplete = false;
    isFront = true;
    sessionVocabList = [];

    const selectedLessonName = document.getElementById('lessonSelector').value;
    const lessonData = lessons.find(lesson => lesson.name === selectedLessonName);

    if (!lessonData) {
        alert(L.lessonNotFound);
        return;
    }

    fetch("LESSON/" + lessonData.name)
        .then(response => response.json())
        .then(data => {
            vocabList = data;
            if (vocabList.length > 0) {
                currentIndex = 0;
                askedIndices = [];
                isRandomCycleComplete = false;
                displayWord();
            } else {
                document.getElementById('vocabLabel').innerText = L.noVocabFound;
            }
        })
        .catch(error => console.error('Error loading vocab:', error));

    fetch("LESSON/" + lessonData.mapping)
        .then(response => response.json())
        .then(data => {
            audioMapping = data;
            try { populateAudioEngineOptions(); } catch (e) {}
        })
        .catch(error => console.error('Error loading mapping:', error));
}

</script>

<script>

/* ============================================================
   PH·∫¶N 4 ‚Äî H√ÄM ƒêI·ªÄU H∆Ø·ªöNG, √ÇM THANH, AUTO FLIP, LOAD LESSON
   ============================================================ */

// ===================== NEXT WORD ======================
function nextWord() {
    if (vocabList.length === 0) return;

    if (isRandomMode) {
        if (askedIndices.length >= vocabList.length) {
            askedIndices = [];
            isRandomCycleComplete = true;
        }

        const availableIndices = [];
        for (let i = 0; i < vocabList.length; i++) {
            if (!askedIndices.includes(i)) availableIndices.push(i);
        }

        currentIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)];
        askedIndices.push(currentIndex);

    } else {
        currentIndex = (currentIndex + 1) % vocabList.length;
    }

    isFront = true;
    displayWord();
}


// ===================== PREVIOUS WORD ======================
function prevWord() {
    if (isRandomMode) {
        nextWord();
    } else {
        currentIndex = (currentIndex - 1 + vocabList.length) % vocabList.length;
        isFront = true;
        displayWord();
    }
}


// ===================== AUTO FLIP ======================
let autoFlipInterval = null;

function toggleAutoFlip() {
    const L = getLang();

    if (autoFlip) {
        autoFlip = false;
        clearInterval(autoFlipInterval);
        document.getElementById("autoFlipButton").innerText = L.autoFlip;
        return;
    }

    autoFlip = true;
    document.getElementById("autoFlipButton").innerText = L.autoFlip;

    const intervalSec = parseInt(document.getElementById("autoIntervalInput").value) || 1;
    const intervalMs = intervalSec * 1000;

    autoFlipInterval = setInterval(() => {
        nextWord();
    }, intervalMs);
}


// ===================== SHOW NOTIFICATION ======================
function showNotification(message, isCorrect) {
    const notification = document.getElementById('notification');
    notification.innerText = message;
    notification.style.display = 'inline-block';
    notification.style.color = '#ffffff';
    notification.style.backgroundColor = isCorrect ? '#4caf50' : '#f44336';

    setTimeout(() => {
        notification.style.display = 'none';
    }, 2000);
}


// ===================== PLAY PRONUNCIATION ======================
let audio;
let lastAudioSrc = '';
let lastPlayTimestamp = 0;
const PLAY_DEBOUNCE_MS = 800;

function playPronunciation(text, onEnd) {
    currentPronunciationText = text;

    const now = Date.now();
    if (text === lastAudioSrc && (now - lastPlayTimestamp) < PLAY_DEBOUNCE_MS) return;
    lastPlayTimestamp = now;
    lastAudioSrc = text;

    if (audio) {
        try { audio.stop(); audio.unload(); } catch (e) {}
        audio = null;
    }

    const engineSel = document.getElementById('audioEngineSelector');
    const preferredEngine = engineSel ? engineSel.value : 'gTTS';

    let audioEntry = audioMapping.find(item => item.text === text && item.engine === preferredEngine);

    if (!audioEntry) {
        if (preferredEngine.endsWith('-male')) {
            audioEntry = audioMapping.find(item => item.text === text && item.id && item.id.endsWith('_male'));
        } else if (preferredEngine.endsWith('-female')) {
            audioEntry = audioMapping.find(item => item.text === text && item.id && item.id.endsWith('_female'));
        }
    }

    if (!audioEntry) audioEntry = audioMapping.find(item => item.text === text);

    if (audioEntry) {
        const audioFilePath = encodeURI("LESSON/" + audioEntry.file);

        const speedSel = document.getElementById('playbackSpeedSelector');
        const playbackRate = speedSel ? (parseFloat(speedSel.value) || 1) : 1;

        audio = new Howl({
            src: [audioFilePath],
            html5: true,
            rate: playbackRate,
            onload: function() {
                try { audio.play(); } catch (e) {}
            },
            onend: function() {
                try { audio.unload(); } catch (e) {}
                audio = null;
                lastAudioSrc = '';
                if (typeof onEnd === 'function') onEnd();
            },
            onloaderror: function(id, error) {
                console.error("Audio load error:", error);
                try { audio.unload(); } catch (e) {}
                audio = null;
                lastAudioSrc = '';
                if (typeof onEnd === 'function') setTimeout(onEnd, 800);
            }
        });

    } else {
        // fallback: browser speech synthesis
        try {
            if ('speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'ja-JP';

                const speedSel = document.getElementById('playbackSpeedSelector');
                const playbackRate = speedSel ? (parseFloat(speedSel.value) || 1) : 1;

                u.rate = playbackRate;
                u.pitch = 0.95;

                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(u);

                if (typeof onEnd === 'function') setTimeout(onEnd, 1000);
            }
        } catch (e) {
            if (typeof onEnd === 'function') setTimeout(onEnd, 800);
        }
    }
}


// ===================== LOAD LESSON LIST ======================
function loadLessonList() {
    fetch("json_list.json")
        .then(response => response.json())
        .then(data => {
            lessons = data.lessons;
            populateLessonSelector();

            if (lessons.length > 0) {
                document.getElementById("lessonSelector").value = lessons[0].name;
                loadLesson();
            }
        })
        .catch(error => console.error("Error loading lesson list:", error));
}


// ===================== POPULATE LESSON SELECTOR ======================
function populateLessonSelector() {
    const lessonSelector = document.getElementById('lessonSelector');
    lessonSelector.innerHTML = "";

    lessons.forEach(lesson => {
        const option = document.createElement('option');
        option.value = lesson.name;
        option.textContent = lesson.name.replace('.json', '');
        lessonSelector.appendChild(option);
    });
}


// ===================== TOGGLE V-FRAME ======================
function toggleVFrame(n) {
    const map = {
        1: { ta: 'answerInput' },
        2: { ta: 'answerInputV2' },
        3: { ta: 'answerInputV3' },
        4: { ta: 'answerInputV4' }
    };

    const cb = document.getElementById('hideV' + n + 'Checkbox');
    const target = map[n];
    if (!target || !cb) return;

    const ta = document.getElementById(target.ta);

    if (cb.checked) {
        if (ta) ta.style.display = 'none';
        if (document.activeElement === ta) ta.blur();
    } else {
        if (ta) ta.style.display = 'block';
    }
}


// ===================== KEYDOWN HANDLERS ======================
function handleKeyDown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        clearTimeout(typingTimer);
        checkAnswer();
    }
}

function handleKeyDownV2(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        clearTimeout(typingTimer);
        checkAnswerV2();
    }
}

function handleKeyDownV3(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        clearTimeout(typingTimer);
        checkAnswerV3();
    }
}

function handleKeyDownV4(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        clearTimeout(typingTimer);
        checkAnswerV4();
    }
}

</script>

<script>

/* ============================================================
   PH·∫¶N 5 ‚Äî CHECK ANSWERS + BOOKMARK + K·∫æT TH√öC FILE
   ============================================================ */

/* ===================== CHECK ANSWER V1 ====================== */
function checkAnswer() {
    if (vocabList.length === 0) return;

    const userInput = document.getElementById('answerInput').value.trim();
    const correct = vocabList[currentIndex][0].toString().trim();

    if (userInput === correct) {
        showNotification("‚úî", true);
        nextWord();
    } else {
        showNotification(correct, false);
    }
}


/* ===================== CHECK ANSWER V2 ====================== */
function checkAnswerV2() {
    if (vocabList.length === 0) return;

    const userInput = document.getElementById('answerInputV2').value.trim();
    const correct = vocabList[currentIndex][1].toString().trim();

    if (userInput === correct) {
        showNotification("‚úî", true);
        nextWord();
    } else {
        showNotification(correct, false);
    }
}


/* ===================== CHECK ANSWER V3 ====================== */
function checkAnswerV3() {
    if (vocabList.length === 0) return;

    const userInput = document.getElementById('answerInputV3').value.trim().toLowerCase();
    const correct = vocabList[currentIndex][2].toString().trim().toLowerCase();

    if (userInput === correct) {
        showNotification("‚úî", true);
        nextWord();
    } else {
        showNotification(correct, false);
    }
}


/* ===================== CHECK ANSWER V4 ====================== */
function checkAnswerV4() {
    if (vocabList.length === 0) return;

    const userInput = document.getElementById('answerInputV4').value.trim().toLowerCase();
    const correct = vocabList[currentIndex][3].toString().trim().toLowerCase();

    if (userInput === correct) {
        showNotification("‚úî", true);
        nextWord();
    } else {
        showNotification(correct, false);
    }
}


/* ===================== BOOKMARK SAVE ====================== */
function saveBookmark() {
    const lesson = document.getElementById("lessonSelector").value;
    const key = "bookmark_" + lesson;

    const data = {
        index: currentIndex,
        lang: currentLang
    };

    localStorage.setItem(key, JSON.stringify(data));
    showNotification("ƒê√£ l∆∞u v·ªã tr√≠!", true);
}


/* ===================== BOOKMARK LOAD ====================== */
function loadBookmark() {
    const lesson = document.getElementById("lessonSelector").value;
    const key = "bookmark_" + lesson;

    const saved = localStorage.getItem(key);
    if (!saved) {
        showNotification("Ch∆∞a c√≥ bookmark!", false);
        return;
    }

    const data = JSON.parse(saved);

    currentIndex = data.index || 0;
    currentLang = data.lang || "vi";

    applyLanguage();
    displayWord();

    showNotification("ƒê√£ t·∫£i bookmark!", true);
}

</script>

</body>
</html>