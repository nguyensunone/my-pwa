<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ƒê√≥ng Vai H·ªôi Tho·∫°i</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #1e1e2f; color: #fff; padding: 20px; text-align: center; }
    .card, .translation, .hint, .feedback, .fade { transition: opacity 0.5s ease-in-out; }
    .card { background: #2b2d42; padding: 20px; border-radius: 12px; margin: 20px auto; max-width: 700px; font-size: 20px; }
    select, button, input[type="radio"], input[type="text"], input[type="number"], label { margin: 10px; padding: 10px; font-size: 16px; }
    .translation { font-style: italic; color: #a0e0f0; margin-top: 10px; }
    .hint { color: #ffd166; margin: 10px auto; font-style: italic; font-size: 18px; }
    .correct { color: #4cc9f0; font-weight: bold; }
    .wrong { color: #f72585; font-weight: bold; }
    .hidden { opacity: 0; pointer-events: none; height: 0; overflow: hidden; }
    .visible { opacity: 1; }
    .mic-status { margin: 10px; font-style: italic; }
    .prompt-message { color: #8ac926; font-style: italic; margin: 15px 0; font-size: 18px; }
    .vietnamese-prompt { color: #f8f9fa; font-weight: bold; margin: 10px 0; }
    .progress-container { margin: 15px 0; font-size: 18px; }
    .range-selector { display: flex; justify-content: center; align-items: center; margin: 10px 0; }
    .range-selector input { width: 60px; text-align: center; }
    .button-group { display: flex; justify-content: center; gap: 10px; margin: 15px 0; }
  </style>
</head>
<body>
  <h1>üé≠ ƒê√≥ng Vai H·ªôi Tho·∫°i</h1>
  <!-- Thanh ch·ªçn ·ª©ng d·ª•ng -->
<div class="app-nav">
  <select id="appSelector" onchange="switchApp()">
    <option value="translation_practice.html">Luy·ªán D·ªãch Vi·ªát-Anh</option>
    <option value="qa_en.html">Luy·ªán H·ªèi ƒê√°p Ti·∫øng Anh</option>
    <option value="role_play.html">ƒê√≥ng Vai H·ªôi Tho·∫°i</option>
  </select>
</div>

  <div>
    <select id="lessonSelector"></select>
    <button id="loadLessonBtn">üì• T·∫£i B√†i H·ªçc</button><br>
    
    <div class="range-selector">
      <span>Ch·ªçn c√¢u:</span>
      <input type="number" id="startRange" min="1" value="1">
      <span>ƒë·∫øn</span>
      <input type="number" id="endRange" min="1" value="10">
    </div>
    
    <label><input type="radio" name="role" value="answer" checked> T√¥i l√† Ng∆∞·ªùi tr·∫£ l·ªùi</label>
    <label><input type="radio" name="role" value="ask"> T√¥i l√† Ng∆∞·ªùi h·ªèi</label><br>
    <label><input type="checkbox" id="hidePrompts"> ·∫®n G·ª£i √ù v√† C√¢u Tho·∫°i</label><br>
    <button id="startRolePlayBtn">üé¨ B·∫Øt ƒë·∫ßu ƒê√≥ng Vai</button>
  </div>
  
  <div class="progress-container">
    Ti·∫øn tr√¨nh: <span id="progress">-</span>
  </div>
  
  <div class="card fade" id="dialogueDisplay">C√¢u tho·∫°i s·∫Ω xu·∫•t hi·ªán t·∫°i ƒë√¢y.</div>
  <div id="translation" class="translation fade"></div>
  <div id="hint" class="hint fade"></div>
  <div id="vietnamesePrompt" class="vietnamese-prompt"></div>
  <div id="promptMessage" class="prompt-message"></div>
  <input type="text" id="userInput" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi ho·∫∑c n√≥i...">
  
  <div class="button-group">
    <button id="checkAnswerBtn">Ki·ªÉm tra</button>
    <button id="skipBtn">‚è≠ B·ªè qua</button>
    <button id="micButton">üé§ B·∫≠t Microphone</button>
  </div>
  
  <div id="micStatus" class="mic-status">Microphone: T·∫Øt</div>
  <div id="feedback" class="feedback"></div>
<script>
let lessonData = [];
let mappingData = [];
let lessons = [];
let currentIndex = 0;
let role = "answer";
let expectedText = "";
let recognition = null;
let isMicActive = false;
let isPlayingAudio = false;
let startRange = 1;
let endRange = 10;
let micRetryCount = 0;
const MAX_MIC_RETRY = 3;

// Kh·ªüi t·∫°o s·ª± ki·ªán khi trang t·∫£i xong
document.addEventListener('DOMContentLoaded', function() {
  // G√°n s·ª± ki·ªán cho c√°c n√∫t
  document.getElementById('loadLessonBtn').addEventListener('click', loadLesson);
  document.getElementById('startRolePlayBtn').addEventListener('click', startRolePlay);
  document.getElementById('checkAnswerBtn').addEventListener('click', checkAnswer);
  document.getElementById('skipBtn').addEventListener('click', skipDialogue);
  document.getElementById('micButton').addEventListener('click', toggleMic);
  document.getElementById('hidePrompts').addEventListener('change', togglePrompts);
  // T·ª± ƒë·ªông ch·ªçn ƒë√∫ng ·ª©ng d·ª•ng ƒëang m·ªü
  document.getElementById('appSelector').value = location.pathname.split('/').pop();
  document.getElementById('userInput').addEventListener('keydown', function(e) {
    if(e.key === 'Enter') checkAnswer();
  });
  
  // S·ª± ki·ªán cho ph·∫°m vi c√¢u
  document.getElementById('startRange').addEventListener('change', updateRange);
  document.getElementById('endRange').addEventListener('change', updateRange);
  
  // T·∫£i danh s√°ch b√†i h·ªçc
  loadLessonList();
});

function loadLessonList() {
  fetch("json_list.json")
    .then(res => res.json())
    .then(data => {
      lessons = data.lessons || [];
      const selector = document.getElementById("lessonSelector");
      selector.innerHTML = '';
      lessons.forEach(lesson => {
        const opt = document.createElement("option");
        opt.value = lesson.name;
        opt.innerText = lesson.name.replace(".json", "");
        selector.appendChild(opt);
      });
    })
    .catch(err => {
      console.error("L·ªói khi t·∫£i danh s√°ch b√†i h·ªçc:", err);
    });
}

function updateRange() {
  startRange = parseInt(document.getElementById("startRange").value) || 1;
  endRange = parseInt(document.getElementById("endRange").value) || 10;
  
  if (startRange > endRange) {
    endRange = startRange;
    document.getElementById("endRange").value = endRange;
  }
  
  if (lessonData.length > 0) {
    const maxLength = lessonData.length;
    if (endRange > maxLength) {
      endRange = maxLength;
      document.getElementById("endRange").value = endRange;
    }
    if (startRange > maxLength) {
      startRange = maxLength;
      document.getElementById("startRange").value = startRange;
    }
  }
  
  updateProgress();
}

function updateProgress() {
  const total = endRange - startRange + 1;
  const current = currentIndex - startRange + 1;
  document.getElementById("progress").innerText = 
    (currentIndex >= startRange && currentIndex <= endRange) 
      ? `${current}/${total}` 
      : "-";
}

function togglePrompts() {
  const hide = document.getElementById("hidePrompts").checked;
  ["dialogueDisplay", "translation", "hint", "promptMessage", "vietnamesePrompt"].forEach(id => {
    const el = document.getElementById(id);
    el.className = hide ? "hidden" : 
      id === "promptMessage" ? "prompt-message" : 
      id === "vietnamesePrompt" ? "vietnamese-prompt" : "fade visible";
  });
}

function loadLesson() {
  const selected = document.getElementById("lessonSelector").value;
  const lesson = lessons.find(l => l.name === selected);
  if (!lesson) return alert("Kh√¥ng t√¨m th·∫•y b√†i h·ªçc!");

  Promise.all([
    fetch("LESSON/" + lesson.name).then(res => res.json()),
    fetch("LESSON/" + lesson.mapping).then(res => res.json())
  ]).then(([data, mapping]) => {
    lessonData = data;
    mappingData = Array.isArray(mapping) ? mapping : [mapping];
    document.getElementById("startRange").max = lessonData.length;
    document.getElementById("endRange").max = lessonData.length;
    document.getElementById("endRange").value = Math.min(10, lessonData.length);
    updateRange();
    document.getElementById("dialogueDisplay").innerText = "‚úÖ B√†i h·ªçc ƒë√£ ƒë∆∞·ª£c t·∫£i. Ch·ªçn ch·∫ø ƒë·ªô v√† nh·∫•n b·∫Øt ƒë·∫ßu.";
  }).catch(err => {
    alert("‚ùå Kh√¥ng th·ªÉ t·∫£i b√†i h·ªçc ho·∫∑c mapping.");
    console.error(err);
  });
}

function startRolePlay() {
  if (lessonData.length === 0) {
    alert("Vui l√≤ng t·∫£i b√†i h·ªçc tr∆∞·ªõc!");
    return;
  }
  
  role = document.querySelector('input[name="role"]:checked').value;
  currentIndex = startRange - 1;
  document.getElementById("feedback").innerHTML = "";
  document.getElementById("promptMessage").innerHTML = "";
  document.getElementById("vietnamesePrompt").innerHTML = "";
  togglePrompts();
  nextDialogue();
}

function nextDialogue() {
  updateProgress();
  
  if (currentIndex > endRange - 1 || currentIndex >= lessonData.length) {
    document.getElementById("dialogueDisplay").innerText = `‚úÖ Ho√†n t·∫•t ƒëo·∫°n h·ªôi tho·∫°i (${startRange}-${endRange}).`;
    document.getElementById("translation").innerText = "";
    document.getElementById("hint").innerText = "";
    document.getElementById("promptMessage").innerText = "";
    document.getElementById("vietnamesePrompt").innerText = "";
    stopMic();
    return;
  }

  const item = lessonData[currentIndex];
  let text, translation, hintText, vietnamesePrompt;

  if (role === "answer") {
    text = item[0]; 
    translation = item[2]; 
    expectedText = item[3];
    hintText = "üëâ B·∫°n c·∫ßn tr·∫£ l·ªùi: " + item[5];
    vietnamesePrompt = "";
  } else {
    text = item[3]; 
    translation = item[5]; 
    expectedText = item[0];
    hintText = "";
    vietnamesePrompt = "üí¨ H√£y h·ªèi: " + item[2];
  }

  document.getElementById("dialogueDisplay").innerText = text;
  document.getElementById("translation").innerText = role === "answer" ? "üí¨ " + translation : "";
  document.getElementById("hint").innerText = hintText;
  document.getElementById("vietnamesePrompt").innerText = vietnamesePrompt;
  document.getElementById("userInput").value = "";
  document.getElementById("userInput").focus();

  if (role === "answer") {
    isPlayingAudio = true;
    document.getElementById("promptMessage").innerText = "";
    playAudio(text, () => {
      isPlayingAudio = false;
      if (isMicActive) {
        startMic();
      }
    });
  } else {
    isPlayingAudio = false;
    document.getElementById("promptMessage").innerText = "üîä H√£y n√≥i b·∫±ng ti·∫øng Anh";
    if (isMicActive) {
      startMic();
    }
  }
}

function playAudio(text, callback) {
  const audio = mappingData.find(a => a.text === text);
  if (!audio) {
    if (callback) callback();
    return;
  }
  
  const sound = new Howl({ 
    src: ["LESSON/" + audio.file], 
    html5: true,
    onend: callback
  });
  sound.play();
}

function toggleMic() {
  if (isMicActive) {
    stopMic();
  } else {
    startMic();
  }
}

function startMic() {
  if (isPlayingAudio) return;
  
  if ('webkitSpeechRecognition' in window) {
    // D·ª´ng recognition hi·ªán t·∫°i n·∫øu c√≥
    if (recognition) {
      recognition.stop();
    }
    
    recognition = new webkitSpeechRecognition();
    recognition.continuous = true;
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    
    recognition.onresult = (event) => {
      const result = event.results[event.results.length - 1][0].transcript.trim();
      document.getElementById("userInput").value = result;
      checkAnswer();
      micRetryCount = 0; // Reset retry count on successful recognition
    };
    
    recognition.onerror = (event) => {
      console.log("Speech recognition error", event.error);
      if (event.error === 'no-speech') {
        // T·ª± ƒë·ªông kh·ªüi ƒë·ªông l·∫°i n·∫øu kh√¥ng c√≥ gi·ªçng n√≥i
        if (micRetryCount < MAX_MIC_RETRY) {
          micRetryCount++;
          setTimeout(() => {
            if (isMicActive) recognition.start();
          }, 500);
        } else {
          document.getElementById("micStatus").innerText = "Microphone: T·∫°m d·ª´ng do kh√¥ng ph√°t hi·ªán gi·ªçng n√≥i";
          isMicActive = false;
          document.getElementById("micButton").textContent = "üé§ B·∫≠t Microphone";
        }
      } else {
        document.getElementById("micStatus").innerText = "Microphone: L·ªói - " + event.error;
        isMicActive = false;
        document.getElementById("micButton").textContent = "üé§ B·∫≠t Microphone";
      }
    };
    
    recognition.onend = () => {
      if (isMicActive && !isPlayingAudio) {
        // T·ª± ƒë·ªông kh·ªüi ƒë·ªông l·∫°i v·ªõi delay
        setTimeout(() => {
          if (isMicActive) recognition.start();
        }, 300);
      }
    };
    
    recognition.start();
    isMicActive = true;
    micRetryCount = 0;
    document.getElementById("micStatus").innerText = "Microphone: ƒêang ho·∫°t ƒë·ªông";
    document.getElementById("micButton").textContent = "üé§ T·∫Øt Microphone";
  } else {
    alert("Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ nh·∫≠n d·∫°ng gi·ªçng n√≥i.");
  }
}

function stopMic() {
  if (recognition) {
    recognition.onend = null; // T·∫°m th·ªùi v√¥ hi·ªáu h√≥a s·ª± ki·ªán onend
    recognition.stop();
    recognition = null;
  }
  isMicActive = false;
  micRetryCount = 0;
  document.getElementById("micStatus").innerText = "Microphone: T·∫Øt";
  document.getElementById("micButton").textContent = "üé§ B·∫≠t Microphone";
}

function skipDialogue() {
  moveToNextDialogue();
}

function checkAnswer() {
  const userInput = document.getElementById("userInput").value.trim();
  if (!userInput) {
    alert("Vui l√≤ng nh·∫≠p ho·∫∑c n√≥i c√¢u tr·∫£ l·ªùi!");
    return;
  }

  const correct = normalizeText(expectedText);
  const userAnswer = normalizeText(userInput);
  const score = compareText(correct, userAnswer);
  const feedback = document.getElementById("feedback");

  clearTimeout(window.feedbackTimeout);
  clearTimeout(window.nextDialogueTimeout);

  if (score >= 70) { // Gi·∫£m ng∆∞·ª°ng so s√°nh xu·ªëng 70% ƒë·ªÉ linh ho·∫°t h∆°n
    feedback.innerHTML = `<div class='correct'>‚úÖ ƒê√∫ng! (${score}%)</div>`;
    
    if (role === "ask") {
      const answerText = lessonData[currentIndex][3];
      isPlayingAudio = true;
      
      // T·∫°m d·ª´ng microphone tr∆∞·ªõc khi ph√°t √¢m thanh
      const wasMicActive = isMicActive;
      stopMic();
      
      playAudio(answerText, () => {
        isPlayingAudio = false;
        // T·ª± ƒë·ªông b·∫≠t l·∫°i microphone n·∫øu ƒëang ·ªü tr·∫°ng th√°i active
        if (wasMicActive) {
          startMic();
        }
        
        window.nextDialogueTimeout = setTimeout(() => {
          moveToNextDialogue();
        }, 1000);
      });
    } else {
      window.nextDialogueTimeout = setTimeout(() => {
        moveToNextDialogue();
      }, 1000);
    }
  } else {
    feedback.innerHTML = `<div class='wrong'>‚ùå Ch∆∞a ch√≠nh x√°c (${score}%)<br>ƒê√°p √°n ƒë√∫ng: ${expectedText}</div>`;
    
    window.feedbackTimeout = setTimeout(() => {
      feedback.innerHTML = "";
    }, 3000);
  }
}

function moveToNextDialogue() {
  currentIndex++;
  document.getElementById("feedback").innerHTML = "";
  document.getElementById("userInput").value = "";
  nextDialogue();
}

function normalizeText(text) {
  // Chu·∫©n h√≥a vƒÉn b·∫£n ƒë·ªÉ so s√°nh linh ho·∫°t h∆°n
  return text.toLowerCase()
    .replace(/[.,?!]/g, '') // B·ªè d·∫•u c√¢u
    .replace(/\s+/g, ' ') // Chu·∫©n h√≥a kho·∫£ng tr·∫Øng
    .replace(/\$(\d+)/g, '$1 dollars') // Chuy·ªÉn $5 ‚Üí 5 dollars
    .replace(/(\d+) dollars?/g, '$1 dollar') // Chu·∫©n h√≥a s·ªë nhi·ªÅu
    .replace(/(\b\d+\b)/g, match => {
      // Chuy·ªÉn s·ªë th√†nh ch·ªØ (ƒë∆°n gi·∫£n cho c√°c s·ªë nh·ªè)
      const numbers = ['zero', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine', 'ten'];
      const num = parseInt(match);
      return num >= 0 && num <= 10 ? numbers[num] : match;
    })
    .trim();
}

function switchApp() {
  const selectedApp = document.getElementById('appSelector').value;
  window.location.href = selectedApp;
}

function compareText(a, b) {
  // S·ª≠ d·ª•ng thu·∫≠t to√°n Levenshtein distance c·∫£i ti·∫øn
  a = normalizeText(a);
  b = normalizeText(b);
  
  // N·∫øu gi·ªëng nhau ho√†n to√†n sau khi chu·∫©n h√≥a
  if (a === b) return 100;
  
  // Ki·ªÉm tra n·∫øu m·ªôt chu·ªói l√† t·∫≠p con c·ªßa chu·ªói kia
  if (a.includes(b) || b.includes(a)) return 90;
  
  // T√≠nh ƒëi·ªÉm similarity d·ª±a tr√™n kho·∫£ng c√°ch Levenshtein
  let matrix = Array(a.length+1).fill(null).map(()=>Array(b.length+1).fill(0));
  for(let i=0;i<=a.length;i++) matrix[i][0]=i;
  for(let j=0;j<=b.length;j++) matrix[0][j]=j;
  for(let i=1;i<=a.length;i++){
    for(let j=1;j<=b.length;j++){
      matrix[i][j]=a[i-1]==b[j-1]?matrix[i-1][j-1]:1+Math.min(
        matrix[i-1][j], 
        matrix[i][j-1], 
        matrix[i-1][j-1]
      );
    }
  }
  const distance = matrix[a.length][b.length];
  const maxLen = Math.max(a.length, b.length);
  return Math.round(100 - (distance / maxLen) * 100);
}
</script>
</body>
</html>